---
title: "`r params$title` Package Status Report"
author: "[`r params$repo`](https://github.com/`r params$repo`)"
date: "`r format(Sys.time(), '%B %d, %Y %H:%M %Z')`"
output: html_document
params:
  token: NULL
  packageList: NULL
  title: "Tidyverse"
  repo: "gh.dash"
  qualification_registry_url: NULL
---

This report summarizes the current release and milestone status for a selection of `r params$title` packages hosted on GitHub.

```{r setup, message=FALSE, echo=FALSE}
library(gh.dash)

# Use token from params, fallback to automatic discovery
github_token <- params$token
qualification_registry_url <- params$qualification_registry_url
qualification_registry <- NULL

if (is.null(qualification_registry_url) || !nzchar(qualification_registry_url)) {
  qualification_registry_url <- NULL
} else {
  qualification_registry <- fetch_qualification_registry(qualification_registry_url, github_token)
}

repos <- if (is.null(params$packageList)) {
  warning("No packageList provided; report will be empty.")
  character(0)
} else {
  as.character(params$packageList)
}

status <- if (length(repos) == 0L) {
  data.frame(
    repo = character(0),
    latest_release = character(0),
    upcoming_milestones = character(0),
    dev_branch_status = character(0),
    stringsAsFactors = FALSE
  )
} else {
  summarize_github_repos(
    repos,
    token = github_token,
    qualification_registry = qualification_registry
  )
}
```

```{r report_styles, echo = FALSE, results = 'asis'}
styles <- c(
  "<style>",
  ".status-table-wrapper {",
  "  margin-top: 1.5rem;",
  "  border: 1px solid #e2e8f0;",
  "  border-radius: 0.75rem;",
  "  overflow: visible;",
  "}",
  "",
  ".status-table {",
  "  width: 100%;",
  "  table-layout: fixed;",
  "  border-collapse: collapse;",
  "}",
  "",
  ".status-table thead {",
  "  background: #f1f5f9;",
  "}",
  "",
  ".status-table th {",
  "  text-align: left;",
  "  padding: 0.5rem 0.75rem;",
  "  font-size: 0.85rem;",
  "  font-weight: 600;",
  "  letter-spacing: 0.04em;",
  "  text-transform: uppercase;",
  "  color: #475569;",
  "}",
  "",
  ".info-icon {",
  "  display: inline-flex;",
  "  align-items: center;",
  "  justify-content: center;",
  "  margin-left: 0.4rem;",
  "  width: 1.1rem;",
  "  height: 1.1rem;",
  "  border-radius: 9999px;",
  "  background: #e2e8f0;",
  "  color: #334155;",
  "  font-size: 0.85rem;",
  "  font-weight: 700;",
  "  line-height: 1;",
  "  cursor: help;",
  "  position: relative;",
  "  text-transform: none;",
  "}",
  "",
  ".info-icon::after {",
  "  content: attr(data-tooltip);",
  "  position: absolute;",
  "  top: calc(100% + 0.5rem);",
  "  right: 0;",
  "  left: auto;",
  "  transform: none;",
  "  background: #ffffff;",
  "  color: #000000;",
  "  padding: 0.35rem 0.5rem;",
  "  border-radius: 0.35rem;",
  "  font-size: 1rem;",
  "  font-weight: 500;",
  "  width: min(50ch, 90vw);",
  "  max-width: 90vw;",
  "  box-sizing: border-box;",
  "  white-space: pre-line;",
  "  text-transform: none;",
  "  opacity: 0;",
  "  pointer-events: none;",
  "  transition: opacity 0.15s ease;",
  "  z-index: 10;",
  "}",
  "",
  ".info-icon:hover::after,",
  ".info-icon:focus::after {",
  "  opacity: 1;",
  "}",
  "",
  ".info-icon:focus {",
  "  outline: 2px solid #38bdf8;",
  "  outline-offset: 2px;",
  "}",
  "",
  ".status-table td {",
  "  padding: 0.75rem 0.75rem;",
  "  font-size: 1rem;",
  "  line-height: 1.5;",
  "  color: #1f2937;",
  "  vertical-align: top;",
  "  word-wrap: break-word;",
  "}",
  "",
  ".status-table tbody tr:nth-child(even) {",
  "  background: #f8fafc;",
  "}",
  "",
  ".status-table tbody tr + tr td {",
  "  border-top: 1px solid #e2e8f0;",
  "}",
  "",
  ".status-table__cell--repo {",
  "  font-weight: 600;",
  "  color: #0f172a;",
  "  white-space: nowrap;",
  "}",
  "",
  ".empty-state {",
  "  margin-top: 1.5rem;",
  "  border: 1px dashed #cbd5f5;",
  "  border-radius: 0.75rem;",
  "  background: #f8fafc;",
  "  color: #64748b;",
  "  padding: 1.5rem;",
  "  text-align: center;",
  "  font-size: 1rem;",
  "}",
  "",
  ".badge {",
  "  display: inline-flex;",
  "  align-items: center;",
  "  border-radius: 0.375rem;",
  "  padding: 0.25rem 0.5rem;",
  "  font-size: 1rem;",
  "  font-weight: 600;",
  "  line-height: 1;",
  "  border: 1px solid transparent;",
  "}",
  "",
  ".badge--sky {",
  "  background: #38bdf8;",
  "  color: #0b1120;",
  "  border-color: rgba(8, 47, 73, 0.2);",
  "}",
  "",
  ".badge--emerald {",
  "  background: #d1fae5;",
  "  color: #047857;",
  "  border-color: rgba(4, 120, 87, 0.2);",
  "}",
  "",
  ".badge--slate {",
  "  background: #e2e8f0;",
  "  color: #334155;",
  "  border-color: rgba(51, 65, 85, 0.2);",
  "}",
  "",
  ".badge--milestone {",
  "  color: #0c4a6e;",
  "  border-color: rgba(12, 74, 110, 0.25);",
  "}",
  "</style>"
)

cat(paste(styles, collapse = "\n"))
```

```{r status_table, echo=FALSE}
render_status_table <- function(df) {
  if (!nrow(df)) {
    return(htmltools::div(class = "empty-state", "No repositories available."))
  }

  rows <- lapply(seq_len(nrow(df)), function(i) {
    htmltools::tags$tr(
      htmltools::tags$td(
        class = "status-table__cell status-table__cell--repo",
        htmltools::HTML(df$repo[[i]])
      ),
      htmltools::tags$td(
        class = "status-table__cell",
        htmltools::HTML(df$latest_release[[i]])
      ),
      htmltools::tags$td(
        class = "status-table__cell",
        htmltools::HTML(df$upcoming_milestones[[i]])
      ),
      htmltools::tags$td(
        class = "status-table__cell",
        htmltools::HTML(df$dev_branch_status[[i]])
      )
    )
  })

  tbody <- htmltools::tagAppendChildren(htmltools::tags$tbody(), rows)

  htmltools::browsable(
    htmltools::div(
      class = "status-table-wrapper",
      htmltools::tags$table(
        class = "status-table",
        htmltools::tags$thead(
          htmltools::tags$tr(
            htmltools::tags$th(scope = "col", "Repository"),
            htmltools::tags$th(scope = "col", "Latest release"),
            htmltools::tags$th(scope = "col", "Open milestones"),
            htmltools::tags$th(
              scope = "col",
              htmltools::tagList(
                "Dev status",
                htmltools::tags$span(
                  class = "info-icon",
                  `data-tooltip` = "The difference in commits between 'main' and 'dev' branches: \n A positive number means dev is ahead of main by n commits; \n A negative number means dev is behind main by n commits;\n \"Unavailable\" means that there is no branch named 'dev' and/or 'main'.",
                  `aria-label` = "The difference in commits between 'main' and 'dev' branches: A positive number means dev is ahead of main by n commits; A negative number means dev is behind main by n commits; \"Unavailable\" means that there is no branch named 'dev' and/or 'main'.",
                  tabindex = "0",
                  "i"
                )
              )
            )
          )
        ),
        tbody
      )
    )
  )
}

render_status_table(status)
```
